#!/bin/bash
rebuild()
{
    (
        set -x
        set -e
        PATH="$PWD/bin/mod:$PATH"
        cl_d=../"$(basename "$PWD")"--clones
        mkdir -p "$cl_d"
        for d in "$cl_d"/*
        do
            if test -e "$d"
            then
                ( cd "$d"; git clean -dxf . )
            fi
        done
        git clean -dxf .
        bash -x bin/install-npm-deps.sh
        ./gen-helpers
        # if ! gmake -j4 docbook_targets
        # if ! gmake -j4 screenplay_epub_dests
        if ! gmake -j4 fastrender
        then
            echo "docbook_targets failed"
            false
        fi
        # exit
        if ! gmake -j4 fastrender
        then
            echo "fastrender failed"
            false
        fi
        gmake -j4 test
    )
}
rebuild
