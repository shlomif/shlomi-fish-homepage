#!/bin/bash
rebuild()
{
    (
        set -x
        set -e
        # It builds faster with no $DISPLAY
        unset DISPLAY
        _gmake_target()
        {
            local tgt="$1"
            shift

            if ! time gmake -j"$ncpus" "$tgt"
            then
                echo "$tgt failed"
                false
                return -1
            fi
            return 0
        }
        ncpus="$(nproc)"
        if test -z "$ncpus"
        then
            ncpus="4"
        fi
        PATH="$PWD/bin/mod:$PATH"
        time git clean -dfqx .
        if test "$SKIP_NODE_INST" != '1'
        then
            time bash bin/install-npm-deps.sh
        fi
        time ./gen-helpers
        _gmake_target copy_images_target
        _gmake_target fastrender
        _gmake_target all
        _gmake_target test
    )
}
rebuild
