#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Long;
use IO::All qw/ io /;
use IO::Handle;
use File::Temp ();

my $output_fn;

GetOptions(
    '-o=s' => \$output_fn,
);

if (!defined $output_fn)
{
    die "Output filename not specified";
}

my $buf;

foreach my $fn (@ARGV)
{
    $buf .= (scalar(io->file($fn)->utf8->slurp) =~ s/([^\n])\z/$1\n/mrs);
}

my $t_dir = File::Temp->newdir;

my $temp_fn = $t_dir->dirname() . '/temp.js';

io->file($temp_fn)->utf8->print($buf);

if (system('yuicompressor', '-o', $output_fn, $temp_fn))
{
    if ($ENV{KEEP_COPY})
    {
        io->file($temp_fn) > io->file($ENV{KEEP_COPY});
    }
    die "yuicompressor returned an error - $!";
}
