<html>
<head>
<title>Demo: A Dispatch Function</title>
<link rel="StyleSheet" href="./../../style.css" type="text/css">
</head>
<body>
<table>
<tr>
<td>
<a href="./../../" class="nav">Contents</a></td>
<td>
<a href="./" class="nav">Up</a></td>
<td>
<a href="./behaviour.html" class="nav">Previous</a></td>
<td>
<a href="./lambda-calculus.html" class="nav">Next</a></td>
</tr>
</table>

<h1 class="fcs">2.3.2 Demo: A Dispatch Function</h1>

<p>
It is possible to define more than one closure inside a function. Here is
an example that uses closures to create a simple object-like construct. The
code here borrows heavily from the book 
<a href="http://www-mitpress.mit.edu/sicp/">"Structure and Interpretation of Computer Programs"</a> in which a similar code can be found written in Scheme.
</p>


<p>
<table class="mycode">
<tr class="mycode">
<td class="mycode">
<pre class="mycode">
<font color="#a020f0">#!/usr/bin/perl</font>

<font color="#a52a2a"><b>use strict</b></font>;

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">create_bank_account</font>
{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$name</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$total</font> = <font color="#ff00ff">0</font>;

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$deposit</font> =<font color="#008b8b"> </font><font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$how_much</font> = <font color="#a52a2a"><b>shift</b></font>;

        <font color="#008b8b">$total</font> += <font color="#008b8b">$how_much</font>;
        };

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$print</font> =<font color="#008b8b"> </font><font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$title</font> = <font color="#a52a2a"><b>shift</b></font>;

        <font color="#a52a2a"><b>print</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$name</font><font color="#ff00ff"> has </font><font color="#008b8b">$total</font><font color="#ff00ff"> NIS.</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
    };

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$can_extract</font> =<font color="#008b8b"> </font><font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$how_much</font> = <font color="#a52a2a"><b>shift</b></font>;

        <font color="#a52a2a"><b>if</b></font> (<font color="#008b8b">$how_much</font> &lt;= <font color="#ff00ff">0</font>)
        {
            <font color="#a52a2a"><b>return</b></font>;
        }

        <font color="#a52a2a"><b>if</b></font> (<font color="#008b8b">$total</font> &gt;= <font color="#008b8b">$how_much</font>)
        {
            <font color="#a52a2a"><b>print</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$name</font><font color="#ff00ff"> can afford to pay it!</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
        }
        <font color="#a52a2a"><b>else</b></font>
        {
            <font color="#a52a2a"><b>print</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$name</font><font color="#ff00ff"> cannot afford to pay it!</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
        }
    };

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">%ops</font> =
        (
            <font color="#ff00ff">&quot;</font><font color="#ff00ff">deposit</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">$deposit</font>,
            <font color="#ff00ff">&quot;</font><font color="#ff00ff">print</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">$print</font>,
            <font color="#ff00ff">&quot;</font><font color="#ff00ff">can_extract</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">$can_extract</font>,
        );

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$dispatch</font> =<font color="#008b8b"> </font><font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$op</font> = <font color="#a52a2a"><b>shift</b></font>;

        <font color="#0000ff"># Call the matching operation with the rest of the arguments.</font>
        <font color="#008b8b">$ops</font>{<font color="#008b8b">$op</font>}-&gt;(<font color="#008b8b">@_</font>);
    };

    <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$dispatch</font>;
}

<font color="#0000ff"># Create ten bank accounts</font>
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@accounts</font> = (<font color="#a52a2a"><b>map</b></font> { <font color="#008b8b">&amp;create_bank_account</font>(<font color="#ff00ff">&quot;</font><font color="#ff00ff">Person #</font><font color="#ff00ff">&quot;</font>.<font color="#008b8b">$_</font>) } (<font color="#ff00ff">0</font> .. <font color="#ff00ff">9</font>));

<font color="#a52a2a"><b>my</b></font> (<font color="#008b8b">$line</font>, <font color="#008b8b">@components</font>);
<font color="#a52a2a"><b>while</b></font> (<font color="#008b8b">$line</font> = &lt;&gt;)
{
    <font color="#a52a2a"><b>chomp</b></font>(<font color="#008b8b">$line</font>);
    <font color="#008b8b">@components</font> = <font color="#a52a2a"><b>split</b></font>(<font color="#a52a2a"><b>/</b></font><font color="#6a5acd">\s</font><font color="#6a5acd">+</font><font color="#a52a2a"><b>/</b></font>, <font color="#008b8b">$line</font>);
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$account_index</font> = <font color="#a52a2a"><b>shift</b></font>(<font color="#008b8b">@components</font>);
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$op</font> = <font color="#a52a2a"><b>shift</b></font>(<font color="#008b8b">@components</font>);

    <font color="#008b8b">$accounts</font>[<font color="#008b8b">$account_index</font>]-&gt;(<font color="#008b8b">$op</font>, <font color="#008b8b">@components</font>);
}

<font color="#0000ff"># Usage:</font>
<font color="#0000ff"># [Account Number] [Operation] [Parameters]</font>

</pre>
</td>
</tr>
</table>
</p>




<hr>
<table>
<tr>
<td>
<a href="./../../" class="nav">Contents</a></td>
<td>
<a href="./" class="nav">Up</a></td>
<td>
<a href="./behaviour.html" class="nav">Previous</a></td>
<td>
<a href="./lambda-calculus.html" class="nav">Next</a></td>
</tr>
</table>

</body>
</html>


