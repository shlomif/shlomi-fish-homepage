#!/bin/bash
rebuild()
{
    (
        set -x
        set -e
        _gmake_target()
        {
            local tgt="$1"
            shift

            if ! time gmake -j"$ncpus" "$tgt"
            then
                echo "$tgt failed"
                false
                return -1
            fi
            return 0
        }
        ncpus="$(nproc)"
        if test -z "$ncpus"
        then
            ncpus="4"
        fi
        PATH="$PWD/bin/mod:$PATH"
        no_longer_needed_due_to_avoiding_recursive_make=false
        if $no_longer_needed_due_to_avoiding_recursive_make
        then
            cl_d=../"$(basename "$PWD")"--clones
            mkdir -p "$cl_d"
            for d in "$cl_d"/*
            do
                if test -e "$d"
                then
                    ( cd "$d"; time git clean -dxf . )
                fi
            done
        fi
        time git clean -dxf .
        time bash -x bin/install-npm-deps.sh
        time ./gen-helpers
        # if ! gmake -j"$ncpus" docbook_targets
        # if ! gmake -j"$ncpus" screenplay_epub_dests
        _gmake_target copy_images_target
        _gmake_target fastrender
        _gmake_target test
    )
}
rebuild
